#!/bin/bash -e

cd ../ObHack-engine-697
rm -f CONFIG.cfg MAP*txt
cp scripts/writer.lua writer.lua.save
cat scripts/writer.lua | sed 's/if false/if true/' > foo
mv foo scripts/writer.lua

./ObHack 2FreeDoom1 || true

unix2dos MAP*txt
sha256sum MAP*txt | tr '*' ' ' > output.test
cat > output.success << EOF
06d6727aa15a3976d1c7b4c1626312609ef803e89150d7e32eebaf5822d3725f  MAP01.txt
c9a314a6c9cc27ff7e4e11a6a2f37cfd4c2d1a9674cd23004e78feac2d11f32f  MAP02.txt
f79f41c4791eea8a23a9a6a20fafe7b144e9a84668d6db0cf0cad70438e02a2d  MAP03.txt
1591cb156bb920a969da8c1ee8ee3bb69d22687a81a920cda958a972e9c9a11a  MAP04.txt
e96c5cd4b01f77217ab2ded8ef6938761f402f1ad3f328dc4d443bc8141aa36f  MAP05.txt
b6e367ff82c300cb9ddab9ccbebffae06d4764694f3713037239170d880663b5  MAP06.txt
ba22d89fe478f2fa9799115691a4aa482cf6a55f806d8b2feddf9e498f423a6c  MAP07.txt
e45b8a326adaf58e0da946343ff94c0d5966dab992b1af4926128df9a0c69a80  MAP08.txt
816daf5ba2f9b7466e33ed659a5d24311a2d7ae034e7835fa12dc0e677126aaa  MAP09.txt
a5a5a045ddd391b435c81bad1d97a808e4bc988028773781d7c40df36f0010d6  MAP10.txt
d7d94e0631bc2f78f8f6420011f28735d49959241897bfb769bf314189d77766  MAP11.txt
02fd31055316270c078f23392309c0695f91e69848a6bd74c136239a877cf54a  MAP12.txt
c34e4518ac376189f8bdf8f9f74a0bd19936f75e0e27f0e4369a8b9c6a08ab10  MAP13.txt
d8fee922a4bba6fcd331ac66dffa1eeea82708bdbdb2f632c015c399e3cd9440  MAP14.txt
040bb27c4551ed373ad6fec1c53ed7563064ecca11d209bb3eaf66571092213a  MAP15.txt
eccedc777ec598190d4ccbe51744ebfc3b2d7e5c595f17dd4615b8e2270b8155  MAP16.txt
05e44b7a8e81c1203e1ebe408909888acc39460cf2fb1e3e83088c7667e3896a  MAP17.txt
320110a4d2c00858a37314e9d132c699d88dc5f474186cf93a476fa9c2aba43b  MAP18.txt
cf8b2804a33f40ddbe24c1b51423aa8cbb8ddbc9fe4a58b4546e4c7b76bea7e7  MAP19.txt
c817fcae0e9a1531f47e7bd2611082cc85399d72d319d74247e0d1ae99d36068  MAP20.txt
8bfc9e21b0ecb631974cf67dc52a03762b929bccde1da7510fbca36adf749bd5  MAP21.txt
f2881672c91006a564dc41b172464f7031bcfcad01a96180ef3221edc8cd27e2  MAP22.txt
71809122bd3c0dafa3bb7ba32388d37710be6f043ee3b87acbc504d95382e3f5  MAP23.txt
4c9a237521ffe0ccef4fc66c3f97ab431bdcbfb6e2d6a5391eaef7e8c21bea99  MAP24.txt
c64adb5fa8dd3c02014bb0a0e6ec8372bb3fa320e870c6ca61b415ca321abf78  MAP25.txt
47a7e2c1e43d6ed47d7d007a8184767ca945c739588aabed51961d1eb8fb84c8  MAP26.txt
b7c9ea7c0935d87ce1d72c7328a446ace192226d6489efb94f41586657d152a1  MAP27.txt
920d1bb037d32bcefb58f5688e7ef651f41fd014ccb3a07608775df2b060cd53  MAP28.txt
501e0bdec6731f095bc0fdf2b8ff5e817ff088c8bfe60efa8911b1b38c99f026  MAP29.txt
1b969cdefee1e8ab8ebd088787d0dee217d7fc75807101ad97ba8cc916c57ffb  MAP30.txt
6b1a62ac427722d7ec5adb2fc1b4d7fdb0bf8d5d87e35abd0c09fef0a440c63a  MAP31.txt
97ad7a2e50cf265dd93547fe7153a1947451055431e5bc9641edf9f2d34c8ceb  MAP32.txt
EOF

echo Please ignore the glBSP errors above, we are running ObHack in a 
echo special test mode.

if ! cmp output.success output.test > /dev/null 2>&1 ; then
	echo Test failed
	mv writer.lua.save scripts/writer.lua
	exit 1
fi

echo Test success

# Clean up
mv writer.lua.save scripts/writer.lua
rm MAP*txt
rm output.test
rm output.success
rm LOGS.txt
