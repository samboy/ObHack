#!/bin/bash -e

cd ../ObHack-engine-697
rm -f CONFIG.cfg MAP*txt
cp scripts/writer.lua writer.lua.save
cat scripts/writer.lua | sed 's/if false/if true/' > foo
mv foo scripts/writer.lua

./ObHack 2FreeDoom1 || true

unix2dos MAP*txt
sha256sum MAP*txt | tr '*' ' ' > output.test
cat > output.success << EOF
a0cfff40248941b4c3d99d6546492e1f759bd29e38b789f8864b901d0de68046  MAP01.txt
5916306ae6db9537c59844c1e9baf0f6b4c7d7bf57bcbc1d33add7be2342d954  MAP02.txt
f25294f4584c8bf3bf6d2ce9c8e48017e9a8e08d6d05bff19ae98f0d94e28e48  MAP03.txt
f2080f324022a35a5ed98f06af58505ab62e7107f3735f048fa318e951132ede  MAP04.txt
d1cadcbae149d18a3a858e596ec6dbae2723df7ccc650d4add926b91efcba1af  MAP05.txt
6707e33a37bc6ff0cb959a2bc0013fa35282d1fb56f176d995148e62b2c2f566  MAP06.txt
50fbdfef4e98cb866cabfbbb5df964389023d57c8492bf3942ce803405b58843  MAP07.txt
e48a1867b30e4f8f5a2255a11f5f36edc8507a93f5bbb9f4b48aefe8267b7e91  MAP08.txt
2cf80360b2a6a27631b4100d169740268a003d06aa94ee4cb7ed9c65f0a025e4  MAP09.txt
88d5bdd3679a75e686cfc7afb7f82d38a65f7ff78893cda95ba46c8f9f381239  MAP10.txt
cef71764a223fefd3fb9b983a3e9c027772ec8cd4b3b60f07f0ad9efce8f1037  MAP11.txt
bf978a0609d2e0f5ed40fec956bf7bc19d196d5e6c8ee2355f72903f1aeaa09a  MAP12.txt
ff8a044067a08d02366cf4e99ec9c819284da3f2593efedbfa9e373a1a0047e9  MAP13.txt
81d0f52548d65308b4fdcaefe3e93f46d7f95360fd6c67bbfae748c8da8c9a11  MAP14.txt
a5c10ab81abd0db72585f0273e02a22f905460ae5d0259950c4e4e80a46746f9  MAP15.txt
a40c3911d05da4d1e5b6dfe6f036fbbb8732d3b1c28369cf2490793334101a50  MAP16.txt
c30df4911c7843bcaed3e06e5fa9393438b2f4248445cc04db2e0364f640f58f  MAP17.txt
8d07d65f50e7b115855ca4690bd3d4c5f30f14d647477daa36955d62e460cd90  MAP18.txt
5d1909dd4b66f06420fe3a726a835777258c8d07c6ebdd9277d15b67b2214b8a  MAP19.txt
23ed8a6476994eb99d05c1f1f1c93b6fe4ea79068b9c15660bc5f8f405c8ca09  MAP20.txt
8dec1cd7f6e1b46cef60928cb0a59dc81e65a477bed980a5ee67630447016f77  MAP21.txt
860c45d24538086d4d05bfc19186f0d5e9c0be8c81ff2e0e559a739df0895582  MAP22.txt
d4fccafc3df63eab07de0550bb4860d797f12cca9f2cbef11e3fc6fd2a8ce810  MAP23.txt
f5bb59698bf7703fb745d8ac326e0d5150bbf22839ccb5b480f44e7f622bfcd3  MAP24.txt
64e34bf8a48958435dd5b020f182c18fb528502409c9549d8b5e31cbe40385fb  MAP25.txt
21183cb93142fdd5522f75b3750123efa63c9af1a2f3e511cc7c871410e2a57b  MAP26.txt
07d5405818486ec006af664ca5ff77790a68d3cd4d461bfdf9192ae5560ad302  MAP27.txt
750d10e2b617eef207c705e63fd72f5e1d5431da0802267816eb783e97f9e02b  MAP28.txt
e888dcfc9db4a0b3f7166bd1c1eca88c10ca918c7660bab6d59d6b20f99a98de  MAP29.txt
234ee6482c8e251c82ea2565366e831f630387e00d6cff6685d26ed75f85238c  MAP30.txt
c6f9ea6ebfeef9948d96ae3c394cb11154685e31ed48d9c189ce0a2f9698a4db  MAP31.txt
c40dacd002381f65120b566124c3e37724b1931b0090de454c596167c4a28255  MAP32.txt
EOF

echo Please ignore the glBSP errors above, we are running ObHack in a 
echo special test mode.

if ! cmp output.success output.test > /dev/null 2>&1 ; then
	echo Test failed
	mv writer.lua.save scripts/writer.lua
	exit 1
fi

echo Test success

# Clean up
mv writer.lua.save scripts/writer.lua
rm MAP*txt
rm output.test
rm output.success
rm LOGS.txt
