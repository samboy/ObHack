#!/bin/bash -e

cd ../ObHack-engine-697
rm -f CONFIG.cfg MAP*txt
cp scripts/writer.lua writer.lua.save
cat scripts/writer.lua | sed 's/if false/if true/' > foo
mv foo scripts/writer.lua
./ObHack 1FreeDoom1 || true
unix2dos MAP*txt
sha256sum MAP*txt | tr '*' ' ' > output.test
cat > output.success << EOF
4876f4aeeca16a661cb7ae06816d1c095b42d55683d375b1998ad0480d1302a5  MAP01.txt
305dead8cce25438b5cc7ce30e4ef9e285f20c02397a34d36a653c87da99dcc2  MAP02.txt
71c2aec47701622c87c47052949813e6a87de533cd0be2b3662598997ab5930d  MAP03.txt
1fa1df24a3089992049b383aeba307628c8bf4e7b057a854730026434781e141  MAP04.txt
9b60d630276593484293dde383f823e7395982c0d02f6e1469219dd0a8c10765  MAP05.txt
90858f5bb0d685c1756029bb692d707fc1c77f1fe4efabbf37a56e705402fbb0  MAP06.txt
4c10630c51090677293d81e97d8ceb518b00df2cf4bcc4706f88157561aad53d  MAP07.txt
d86fa6b698ace0ab58267f1484bede9094109a7540992c04e949926133a60de1  MAP08.txt
7a70a59f8cfa4f1aefea3a1e266167b1297e4257a726d6a0b964db92d1b86486  MAP09.txt
9fed76aceb5671feb675c87ced10b3e4d6c4a836ef668de13c0d00c2fbd00e8e  MAP10.txt
da145668376abfc20cc62d011959410890345d504e83c17b2799b71e1d67b046  MAP11.txt
b8947d6414602f292aac1fb01144cb1e6845409c9037182afc0ba31678a2ae7c  MAP12.txt
4b83203ffe28b3a09ee2e90417d5246387e33ef06451984d7da146b8bdb079e3  MAP13.txt
5278ffd714838e944057f5069a370ab4c922fd74622b55c7f287a47d7b5db1e6  MAP14.txt
b1242889409fb47372cd5e99892025eedaf3e5bc6679fda7acc7d0c4fda39b33  MAP15.txt
74af423b900b937c3203ba5ceeba5089d2b95f7cb1d488299b8446fbcbd440d6  MAP16.txt
f3e001515c57e39cf92a72aad84b47df863a19c580adf5611ddfcc85cf725e2f  MAP17.txt
a60d0281c59aed4db512c5291c2a1be44905bc3306a936df950e558755118f36  MAP18.txt
29b6b93981fd3e906bc9164ba87dc1acec335ed060985229c34252811efaaffb  MAP19.txt
25c2016d37febbaac8eb9f3abded5acdbdeac60e5742788c178754806a8ca83a  MAP20.txt
fd871e36af223ff281086397655ad83fd0b1a1a1294eeb1b4b9be4601a5bd418  MAP21.txt
e2cffea6acaf4967f0798b238c624b7a7aa7b21c0df5c4116240f70172d9b0bb  MAP22.txt
e5038091e6764e3e3cfc350952ec54443ec6b3e01badb2787b4bcf377f290402  MAP23.txt
439126454e99a1d66451f8e8d0d3561c7c3551c53c43b05579b69e8689e727cd  MAP24.txt
c31e4b4d0facb1800bf49f7265b1f21b23ecd58a8e1b293f473b3ddd82dd95b6  MAP25.txt
65a53b11736d2aabaa3fd4e62ca25589065368b7ab676eccbf77eaf953c06b02  MAP26.txt
82730811b3ba8fdb1766e3e642283711e7a2eb1bcd13fef06bf73de6463e6ed3  MAP27.txt
2ebd2c0ee24ad2db14b12875efeca0df3a355a526bf6f9113e0917ea09e1cbf6  MAP28.txt
c594149b75446beefac45137435246236bc9dcaff2c678498d1d2cf5da8d387e  MAP29.txt
75806fa6079a6540f4549f7583672293d101aadcb39a8cc9dadacfbde83b61d3  MAP30.txt
c8f6ba5b83fdb74efe1d85eddb2db118e86ca65fcb49422cf2b1438f7dc68a11  MAP31.txt
8507db65af3b2dd921af4675ea2b64ca82229e3acd1ace6e0bca3c590ae40313  MAP32.txt
EOF

echo Please ignore the glBSP errors above, we are running ObHack in a 
echo special test mode.

if ! cmp output.success output.test > /dev/null 2>&1 ; then
	echo Test failed
	mv writer.lua.save scripts/writer.lua
	exit 1
fi

echo Test success

# Clean up
mv writer.lua.save scripts/writer.lua
rm MAP*txt
rm output.test
rm output.success
rm LOGS.txt
