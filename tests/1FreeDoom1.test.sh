#!/bin/bash -e

cd ../ObHack-engine-697
rm -f CONFIG.cfg MAP*txt
cp scripts/writer.lua writer.lua.save
cat scripts/writer.lua | sed 's/if false/if true/' > foo
mv foo scripts/writer.lua
./ObHack 1FreeDoom1 || true
unix2dos MAP*txt
sha256sum MAP*txt | tr '*' ' ' > output.test
cat > output.success << EOF
4876f4aeeca16a661cb7ae06816d1c095b42d55683d375b1998ad0480d1302a5  MAP01.txt
305dead8cce25438b5cc7ce30e4ef9e285f20c02397a34d36a653c87da99dcc2  MAP02.txt
71c2aec47701622c87c47052949813e6a87de533cd0be2b3662598997ab5930d  MAP03.txt
1fa1df24a3089992049b383aeba307628c8bf4e7b057a854730026434781e141  MAP04.txt
9b60d630276593484293dde383f823e7395982c0d02f6e1469219dd0a8c10765  MAP05.txt
90858f5bb0d685c1756029bb692d707fc1c77f1fe4efabbf37a56e705402fbb0  MAP06.txt
4c10630c51090677293d81e97d8ceb518b00df2cf4bcc4706f88157561aad53d  MAP07.txt
db7b6daf11bfd75f430a27eaca5d663f0d84d894952c9f24336769b8988898c2  MAP08.txt
63cb9736523d6a41f37665ae8e1f030d8dee12d332ca6218cb4a95ea78a84570  MAP09.txt
741eb82025386666a12b3ac34bbcc892392cd729f59b051fd6e6884606c27e5b  MAP10.txt
6df8e7f5385adcff95a0b48e05b886cc428257d036d3a1e7dead0fb475696cc7  MAP11.txt
311a009741109d549b9f84636c0d99401b16469d2874602a7a24dc04e551aacb  MAP12.txt
e33b7364685ee6e0052d142abb4c0fdac4567e63e548661db9c0724af9744139  MAP13.txt
d4c552a6360d0e7f5e813b8076a27bc81cd757549a3538f4c276ca7592d5c913  MAP14.txt
0868a2f2cdfbadc2e471394b979f0f2627c7805a5fe1ff63809a75b0d6759dde  MAP15.txt
ac8002f71e66084085f8626cf8a73bb6f51046d51ad6c7b063c7c5e8464c171f  MAP16.txt
33f794d19cacae5052ed89c60d7d1dcf2ca29fe06f84c5156ec72874d4d399f9  MAP17.txt
b0fadf88f0b055dfb4c446f97265ad810e3dc5ad0a6d62144af8c3b5ec2ba6d8  MAP18.txt
c643088727977abe387b7d7f3f4a63d3e32e916bbaff738a8deba9ac2f8c4b9f  MAP19.txt
a8479fe15de68d05e0aff3541ac365cbf7f587451095ca9c173f40e3847255fb  MAP20.txt
01f3df6b9145941d8326b20fd950385c57d417e10b3bdb1de6fa94ebc87ab8c9  MAP21.txt
b507837e403236ef499627ff6f9f675d96b69181ae75e4b202f493280a7933e0  MAP22.txt
34224d183c3066faca3a7b65b7e7b650c40327c47fc5dfeba21ee908aa738d77  MAP23.txt
b68e88b0d280372912333b1dd787e55ea301b7d66b6715b9d4a1e68f837518d4  MAP24.txt
71ec7d9d635e37024fdca2625b58611b9c027bb12ad4bbeb6e8ba5c003fd9656  MAP25.txt
2a375809f387c7e4a30488fb7c3807d2c7f0fd5fc562a6f078e5ec63a5610fe8  MAP26.txt
c8470a52987d52edbe2106754e2f481bdd7a8bdb914420c06129d169c57dd8b2  MAP27.txt
27c61d74953306cb82d10a075d1619e191a93f7fbc87bb0d3465074e35dd1549  MAP28.txt
55161b9df93552b057faec7010f97af72538be30751786a779fcb8f5c8dc60ed  MAP29.txt
4b4d7c241248c60dae264fa97bfb4c84ee0388fd17fe4cdf7c065d3f47f78889  MAP30.txt
2464de2c7d47a9473d0b271e57e411a09539e0c2f189b9459f7d3516f18627b9  MAP31.txt
36734c8ed871272213d57304e0264b7c9100cbafb9f0ff06dfbf0d0aa9581de1  MAP32.txt
EOF

echo Please ignore the glBSP errors above, we are running ObHack in a 
echo special test mode.

if ! cmp output.success output.test > /dev/null 2>&1 ; then
	echo Test failed
	mv writer.lua.save scripts/writer.lua
	exit 1
fi

echo Test success

# Clean up
mv writer.lua.save scripts/writer.lua
rm MAP*txt
rm output.test
rm output.success
rm LOGS.txt
