#!/bin/bash -e

cd ../ObHack-engine-697
rm -f CONFIG.cfg MAP*txt
cp scripts/writer.lua writer.lua.save
cat scripts/writer.lua | sed 's/if false/if true/' > foo
mv foo scripts/writer.lua
./ObHack 1FreeDoom1 || true
unix2dos MAP*txt
sha256sum MAP*txt | tr '*' ' ' > output.test
cat > output.success << EOF
1095d0ea8f6a6f9b0967860053d7dc5384f95582a2668f7c08ec94b47913b5c3  MAP01.txt
b9f08db5b0484ce676a946201328b0323dc0c7bd8e59611fa0148fa1b95d4212  MAP02.txt
09e6691f3ee9d1849a7d591d82087b2bdfb6ef705769110cc716317fe2fc63cd  MAP03.txt
1fa1df24a3089992049b383aeba307628c8bf4e7b057a854730026434781e141  MAP04.txt
feadeca6f84f60093cb9c26ad8e515285a3fd46d64efd97b02c7f6bdc66423ed  MAP05.txt
78d88a6fa622999c0a0e7b7175fb08b3f60de0a93518fbc2799a1efc7933bf2c  MAP06.txt
933f5b9dc16e880a770085fe97575df47ae93c59a673ae160ccfde42d0750fc4  MAP07.txt
84334004a29ed44fa5888be87784a0162612ce61d65e945f58f3e11e48cbe081  MAP08.txt
cf549081345aa5965e7ae113b77cb301977c05eeca31706aa5a10e1afab93482  MAP09.txt
961b6bb87baa398a97f677857e2b590c7b25642e81158fbccd8699e5915b13d5  MAP10.txt
1713243b4049f6e388c98355dc48641814456f1c65faaaa375b9d0c6c931a81c  MAP11.txt
a7462f9e5e43652d0268c6e4721bc312ac3b7a20d2c9437906f4b8f044154a86  MAP12.txt
5892c0d27eb9b6483e6ec4ce3d3b0e1f9d768bf5c79c554b09e19a616e393e38  MAP13.txt
8d3dd0fcc053f95bb3cc44fc2f8c903af8ba4a423439107e9e404aecaae751db  MAP14.txt
c42995d6b2fc8e29d8dfd32328d3d327c5b69eeb9a3fdb276ff1751856ea4c79  MAP15.txt
e09d55dab3e26cf1931d052790f8cd1abdc360947ef6016b19e849cb052da8fe  MAP16.txt
95ff9723edadb3f0ada3d49ac7bcc99a234e532a817685aedfa9c255e717b0a7  MAP17.txt
a978af347967c29c4ead1ba3d0d8cf6cb510161a048b4244c87d0e1592de64c3  MAP18.txt
08bdd174992cd956a8a5084b824474ec382f6a71832eb1a41bdf3543c41e418b  MAP19.txt
6421d1f7e98cc5f678b81f94a1c24d92a953477b466d441e0106393cb1358ea8  MAP20.txt
00d7dcc00513fd03a0e01dd29355382bc95ed729b7337a5ce1e7d5f2fd4d65ce  MAP21.txt
6468610ae222b1cd3ed36d0967350f11c7d3e56fe89c4a1df13d44b3bc374ba2  MAP22.txt
e5038091e6764e3e3cfc350952ec54443ec6b3e01badb2787b4bcf377f290402  MAP23.txt
5427830074734dbfcaccefa825b27ce5a4e2418e82c5edce318f6215778cd6a2  MAP24.txt
c59b5a6dc90c8a71e4ebd037a0452b1bbfbffe8e037df0094d9df52060eafef5  MAP25.txt
6024acf19cebc21f8e85eae4624e9eeef7ce1c22a2e384fe07153b2eccca7af9  MAP26.txt
bc83423fd95fa880987f3b6a65c9b0365cfcd883470a81ab9dd73516a8c5b143  MAP27.txt
0f6653071b5ba0fd1bd04f6aa5d157ce5cd7d42ce761e384d13baabc09b046ff  MAP28.txt
a31d8f991675f77a97411129f6a5802513091adf4c86201631f436c59723b718  MAP29.txt
d05fb4a9eee0769e5f193c8df738447f53d3a8841d070e2751f8cfe1696e4773  MAP30.txt
06ffc70384268ade450cc8b40805cf4fe70f2ea9f0227a444d005fa272a82249  MAP31.txt
25ecc557e7c5d7a2babedd24626a41804cefa16a5c383b25487f4a820e6d06e3  MAP32.txt
EOF

echo Please ignore the glBSP errors above, we are running ObHack in a 
echo special test mode.

if ! cmp output.success output.test > /dev/null 2>&1 ; then
	echo Test failed
	mv writer.lua.save scripts/writer.lua
	exit 1
fi

echo Test success

# Clean up
mv writer.lua.save scripts/writer.lua
rm MAP*txt
rm output.test
rm output.success
rm LOGS.txt
