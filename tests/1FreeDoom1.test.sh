#!/bin/bash -e

cd ../ObHack-engine-697
rm -f CONFIG.cfg MAP*txt
cp scripts/writer.lua writer.lua.save
cat scripts/writer.lua | sed 's/if false/if true/' > foo
mv foo scripts/writer.lua
./ObHack 1FreeDoom1 || true
unix2dos MAP*txt
sha256sum MAP*txt | tr '*' ' ' > output.test
cat > output.success << EOF
bcb167eadb54dffdeeb8f5acc0966f111d8ef7904df5f29124237438753e2644  MAP01.txt
ad128520fddcc7ffd470e32e5d2611b2f66db4f9298508e9b359f905d2f48593  MAP02.txt
8175b77aac6b79f22a76dda18498ef8ed423b42e253f43323257ed26d6e1b2b6  MAP03.txt
ba2e63c16d4471f9440d6f64908e5a033dd211a4045075aafad3933adf47f4d0  MAP04.txt
3d38874975a2cc764fcea12cf990b406ebc7c35ac1406d06598aa4a3df85e294  MAP05.txt
51c683c63bf6ac29ac918ba266d84be69f339a3825dea9be975c9bf28b20dec6  MAP06.txt
6e5813b73eeb7bf56843503bb76e78c662cc1c6ac34801e3e5e177dc07b53cf9  MAP07.txt
fd84b2f9ea415264df5335315481b59ad3bd6637ac37faf3a87aa6577cf1efd9  MAP08.txt
9eaf313551c5eb191ef52b898c4e940131cff6d40403f1b105a39ec7c2b6b977  MAP09.txt
7cd39b127387fc4243712c0c0af5d86c96a919ba7a31c9a550090ab19ad277c1  MAP10.txt
c34fbd7bd796829a588b82a3e10d565dee435f51755c979f31a7a08e268c83f5  MAP11.txt
f63eb5fed99b0010f098f541fe4ad1fd83ca07559ac7bcf9e350900cfaf08504  MAP12.txt
cbd5d32c817b7b329753310e7437dbc8b7c3ccdae5334934f38dde0a7260b624  MAP13.txt
dc4d293038bc9806360c7078713d6baa0ec2f0c290aceda34a27cbe6b3415672  MAP14.txt
36693858f838069da43db4e90ca5305685da6369c76eb89e0aec0aa5e9bd4786  MAP15.txt
0686ec07583aeb621979d30a0a7baf53c3aa0a02ac0d7129cccfba9a3bdcce29  MAP16.txt
d738330ff90053c80dd946dc758ba00a878df7dcbf836d4bde05b9db0554ffcb  MAP17.txt
61bebca7d97088531a8e2338fb361dc9f933b961dc690ac47778cc07b487bd3f  MAP18.txt
8fdac54c2ff7b6c257e42c8d87a450078666853cb9b0f7fb15c239a0192b54a7  MAP19.txt
060916127e42a13efd32b5eac62679573ed1781921aef4e2b89e5d7c294f4a0f  MAP20.txt
9eee61f1640158e1dd937c8df147cfb1a0812c0b74d2c4573c2dd7f71dad7b0e  MAP21.txt
2f0e58ad0392c6a359b651166cce27540b3070569312b1d50099406d54e61b87  MAP22.txt
0e33932e29f96b58c6991901b20375c8aac7973c5c25089644d0daed3f2b0464  MAP23.txt
71d27f16d57d19182d8a7622f2416f23b5a8722f00f182e1cad2272a3878195a  MAP24.txt
e88e0d085407e3a46907a94d802b341f28d82eca8a44587e61af660126277870  MAP25.txt
a056b7275ba2aa539a50590096297d200d98339c12951326aee5a6dd4ab49808  MAP26.txt
328664a19ac34400007c0a9c2d1fa5b29b5c77abf6df95589444db4004da34f5  MAP27.txt
d0bb6d2d635bcedcfd9cb9eda17bc2572442437260673faf7807f62bd3801167  MAP28.txt
00ad169d1d010694a29c06ed83a438e560a5559b9225635487a873608b45a1ec  MAP29.txt
aa7b49082f259df1eeb2b9577b7eca1b115c4ad769787d9ad640f65ee8c69c77  MAP30.txt
eafcbe3cc1e480f0b55adaa375284aa4cdf596082c4ff73150b179e5f3874f5a  MAP31.txt
528f14e6f6813ebdfa3e0652ad02a08ce0eb81fa047356bb678ef56688311f8e  MAP32.txt
EOF

echo Please ignore the glBSP errors above, we are running ObHack in a 
echo special test mode.

if ! cmp output.success output.test > /dev/null 2>&1 ; then
	echo Test failed
	mv writer.lua.save scripts/writer.lua
	exit 1
fi

echo Test success

# Clean up
mv writer.lua.save scripts/writer.lua
rm MAP*txt
rm output.test
rm output.success
rm LOGS.txt
