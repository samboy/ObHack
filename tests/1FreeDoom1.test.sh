#!/bin/bash -e

cd ../ObHack-engine-697
rm -f CONFIG.cfg MAP*txt
cp scripts/writer.lua writer.lua.save
cat scripts/writer.lua | sed 's/if false/if true/' > foo
mv foo scripts/writer.lua
./ObHack 1FreeDoom1 || true
unix2dos MAP*txt
sha256sum MAP*txt | tr '*' ' ' > output.test
cat > output.success << EOF
6ec97c744cf5e101a03b75b83e142f497b88cff3245fab8b6e7e5193312cb031  MAP01.txt
381f5509b5acdf954cf13e663620c0690023c2b3cfbd5ed3cbf8d2d3653110c0  MAP02.txt
71c2aec47701622c87c47052949813e6a87de533cd0be2b3662598997ab5930d  MAP03.txt
2ca7e34a187e6768fc7188be111e246eb9de59446b93ae906fd4d6f3f46dc325  MAP04.txt
d40dc53091da137b6c3b462c057ffc09ca3af5ed0e4ef1e8e7659c7662317db0  MAP05.txt
2681fce58d7d447c989d99743f350a31d0afd1e6104933081a3f8f714f0b7c60  MAP06.txt
79c92eec610a9659e4541e981ebacc6b97ef8da66c6bbc1e207b2e502662ee29  MAP07.txt
db7b6daf11bfd75f430a27eaca5d663f0d84d894952c9f24336769b8988898c2  MAP08.txt
7a70a59f8cfa4f1aefea3a1e266167b1297e4257a726d6a0b964db92d1b86486  MAP09.txt
741eb82025386666a12b3ac34bbcc892392cd729f59b051fd6e6884606c27e5b  MAP10.txt
dc501784f2ee2b4812e97d00ce7f3050705f9c3de4d9139ba78d55a99cb2f37f  MAP11.txt
311a009741109d549b9f84636c0d99401b16469d2874602a7a24dc04e551aacb  MAP12.txt
e33b7364685ee6e0052d142abb4c0fdac4567e63e548661db9c0724af9744139  MAP13.txt
5278ffd714838e944057f5069a370ab4c922fd74622b55c7f287a47d7b5db1e6  MAP14.txt
bdd7be1ea9a649afeec4ba0d001972953d139b28049bdfc4918e70883a26f9fb  MAP15.txt
ac8002f71e66084085f8626cf8a73bb6f51046d51ad6c7b063c7c5e8464c171f  MAP16.txt
c47fa5e44f2228122187430520b0619ea0557e893a3dd57b1445682d0ab01dcc  MAP17.txt
b0fadf88f0b055dfb4c446f97265ad810e3dc5ad0a6d62144af8c3b5ec2ba6d8  MAP18.txt
7637ad3d1bd1b757c0308e389fee7a245a79c88cc0b955e1ac596cd64ab56fa3  MAP19.txt
a8479fe15de68d05e0aff3541ac365cbf7f587451095ca9c173f40e3847255fb  MAP20.txt
f3ce15940c6d79f1669214e1c027ac0dac947966439065cb4e8d52a32f1ac4c3  MAP21.txt
e2cffea6acaf4967f0798b238c624b7a7aa7b21c0df5c4116240f70172d9b0bb  MAP22.txt
e5038091e6764e3e3cfc350952ec54443ec6b3e01badb2787b4bcf377f290402  MAP23.txt
439126454e99a1d66451f8e8d0d3561c7c3551c53c43b05579b69e8689e727cd  MAP24.txt
c31e4b4d0facb1800bf49f7265b1f21b23ecd58a8e1b293f473b3ddd82dd95b6  MAP25.txt
2a375809f387c7e4a30488fb7c3807d2c7f0fd5fc562a6f078e5ec63a5610fe8  MAP26.txt
aaa7ac68f07cd7b36935959b10f3c35cde1707a1122828763e4399df3c4a2237  MAP27.txt
80f300e901be2d32281027cef0f6065e9b3dbaa6e1845dab0e96b2ea13900785  MAP28.txt
55161b9df93552b057faec7010f97af72538be30751786a779fcb8f5c8dc60ed  MAP29.txt
fe2e69c52f402c4eace704d643de8a3a562e0006047105436cb1b39b3f87c893  MAP30.txt
3e267420ed3c8479985a6ebf90906311c2bcb61de9eed5bc4d46a27061e2dedd  MAP31.txt
8507db65af3b2dd921af4675ea2b64ca82229e3acd1ace6e0bca3c590ae40313  MAP32.txt
EOF

echo Please ignore the glBSP errors above, we are running ObHack in a 
echo special test mode.

if ! cmp output.success output.test > /dev/null 2>&1 ; then
	echo Test failed
	mv writer.lua.save scripts/writer.lua
	exit 1
fi

echo Test success

# Clean up
mv writer.lua.save scripts/writer.lua
rm MAP*txt
rm output.test
rm output.success
rm LOGS.txt
